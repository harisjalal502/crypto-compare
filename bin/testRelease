#! /bin/bash

#################### Running this Script #######################
# Verify Git status is clean
# Verify current git is what you're testing
# Run this with `./bin/testRelease
################################################################

SOMETHING_FAILED=0
echo "#########################################################"
echo '# Test a release of Ignite before actually releasing it #'
echo '#                  ._______.                            #'
echo '#                   | \   / |                           #'
echo '#                .--|.O.|.O.|______.                    #'
echo '#              __).-| = | = |/   \ |                    #'
echo "#              >__) (.'---\`.)Q.|.Q.|--.                 #"
echo '#                    \\___// = | = |-.(__               #'
echo "#                     \`---'( .---. ) (__<               #"
echo "#                           \\\\.-.//                     #"
echo "#                            \`---'                      #"
echo '#########################################################'

# Runs command and on failure turns on the SOMETHING_FAILED flag
function test_command {
    "$@"
    local status=$?
    if [ $status -ne 0 ]; then
        echo "üëé üëé üëé üëé üëé üëé üëé üëé - $1 Failed" >&2
        SOMETHING_FAILED=$1
    fi
    return $status
}

setup()
{
  echo '~~~üåü Preparing packages'
  test_command lerna run bootstrap

  echo '~~~üåü Linking local for Testing'
  cd packages/ignite-cli
  test_command npm link
  cd -
}

verify_code()
{
  echo '~~~üåü Checking Code'
  test_command standard ./packages
  test_command npm test
  
  # run integration tests
  cd ./packages/ignite-integration-tests && npm run integration && cd -
}

check_builds()
{
  cd testgrounds/
  echo '~~~üåü Generating Project'
  test_command ignite new TestProj --min

  echo '~~~üåü Checking Builds'
  if [ ! -d "android" ]; then
    echo 'Android folder did not generate'
    SOMETHING_FAILED=1
  fi

  if [ ! -d "ios" ]; then
    echo 'ios folder did not generate'
    SOMETHING_FAILED=1
  fi

  echo '~ Build ios'
  test_command react-native bundle --entry-file index.ios.js --bundle-output test.ios.js

  echo '~ Build android'
  # A failed android build will not exit with a non-zero return!
  # This makes it a bit trickier to test for - look for the fail message instead
  cd android
  ./gradlew assembleRelease | grep -q 'BUILD FAILED'
  if [[ $? -eq 0 ]]; then
    echo 'Android build failed'
    SOMETHING_FAILED=1
  fi
  cd ..

  # back to root
  cd ..
}

clean_up()
{
  echo '~~~üåü Cleanup'
  rm -rf testgrounds
}

# This is where the magic happens
setup
verify_code
check_builds
clean_up

# Done
if [ "$SOMETHING_FAILED" != "0" ]; then
  echo "~~~üëé Done with errors" 1>&2
  echo "$SOMETHING_FAILED"
  exit 1
else
  echo "~~~üëç Everything looks good!"
  # depends on $SECONDS being part of sh
  printf '%dh:%dm:%ds\n' $(($SECONDS/3600)) $(($SECONDS%3600/60)) $(($SECONDS%60))
  exit 0
fi
